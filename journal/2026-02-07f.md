# 2026-02-07f — Hallucination Filters for Validator

## Session Type
Build — analysis + implementation

## What Happened

Started with the goal of adding hallucination filters to the transcript validator. Before building anything, spent time analyzing the actual data to understand what patterns existed.

### Analysis Phase

Computed diarization coverage for every word with prob < 0.5 across both sessions (000001 and 000002). Key data points:

- 5 confirmed hallucinations across both sessions
- 3 distinct detection patterns needed
- The original min_probability filter at 0.5 hit 20+ words in 000002, vast majority real speech (Sanskrit names, quiet moments, hesitations)

### Critical Insight: Single-Word Segments

Choksi noticed that seg 2 "Why" (null speaker, 0.0 coverage) differs from the hallucinations because it lives in an 11-word segment where 10/11 are above 0.99. All confirmed hallucinations are single-word segments. This structural check eliminates false positives without needing probability thresholds for the silence-gap pattern.

### Three Filters Built

1. **Silence gap** — null speaker + zero coverage + single-word segment → 3 hallucinations caught, 0 false positives
2. **Near-zero probability** — prob < 0.01 + single-word segment → catches "Right?" at prob 0.00007 that silence gap misses (it has SPEAKER_00 + 1.0 coverage)
3. **Duplicate segments** — text matches earlier segment → catches seek-boundary duplicates but also real repetitions. Kept as review aid, not default.

Choksi's framing: silence gap and near-zero are eventual defaults for the real UI. Duplicates is for human review. All three useful, different purposes.

### Implementation

- `src/filters.py` — 3 new filter functions, old `min_probability` kept but no longer used by validator
- `tools/transcript_validator/server.py` — 3 query params, old min_prob block removed
- `tools/transcript_validator/validator.html` — 3 toggle buttons replacing "Apply Filter"
- `tools/transcript_validator/validator.js` — generic `toggleFilterState` helper, keyboard shortcuts G/Z/D, all old filterEnabled references cleaned up

## Decisions Made

- **Dropped min_probability as a filter.** It's not a hallucination detector. The low-confidence tab in the notes drawer already surfaces shaky words for manual review.
- **Duplicate segments is a review aid, not a suppression rule.** Real speech repetitions ("Duryodhan was... Duryodhan was...") match the same pattern.
- **Single-word segment check lives at call site, not in filter.** The segment loop already has the context. No need to stamp segment size onto words.

## What's Next

- Enrich 000001 with diarization so all filters work on both sessions
- Test filters in the actual validator UI
- Process more audio to validate on new data
