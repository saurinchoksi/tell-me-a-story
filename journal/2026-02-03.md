# 2026-02-03 — Architecture Clarification

## Summary
Deep dive into pipeline architecture with Claude Desktop. Stripped down to bones, clarified artifact vs. query separation, wrote rearchitecture task for Claude Code.

## The Conversation

Started by reviewing validation notes from yesterday's transcription review. Found two hallucination types:
- Ghost segments (start==end, empty arrays) — structurally empty
- Fabricated filler ("Well." at 0.99 prob) — plausible but wrong

Asked: "Simulate you are a seasoned pipeline architect." This reframed everything.

## Architecture Decisions

**Pipeline produces three artifacts:**
| Artifact | Source | Purpose |
|----------|--------|---------|
| audio-info.json | inspect_audio() | What went in |
| transcript.json | transcribe() | Raw Whisper output |
| diarization.json | diarize() | Raw pyannote output |

**Removed intermediate files:**
- 04-words.json — just a reshape of transcript, derivable
- 05-words-labeled.json — it's a join, do at query time
- 06-utterances.json — derivable from labeled words

**Key insight:** `extract_words()` was unnecessary. We were reshaping data to fit code. Better to write code that traverses the data as-is.

**Filters are query-time predicates:**
```python
assign_speakers(transcript, diarization, word_filter=has_duration)
```
Not pipeline stages. Experiment without changing artifacts.

**Exception for provably useless data:**
- `start == end` → bake into transcribe (100% garbage)
- High temp/compression → keep as query filter (not yet proven)

## Long-Term Vision

Choksi asked about years of accumulated data, training models, "story brain." This validated the architecture: raw artifacts support future extraction. Keep everything, filter at query time.

## Expert Architect Advice

Asked "what would expert architects advise?" Key takeaway:
> "You're asking the right question at the wrong time. Validate transcription first. Architecture elegance is premature."

But the clarification was valuable — now we know what we're building toward.

## What's Next

1. Claude Code executes rearchitecture (SYNC.md has task)
2. Add zero-length filter to transcribe()
3. Generate high temp/compression report
4. Continue transcription validation

## Technical Artifacts
- SYNC.md updated with full rearchitecture task
- CURRENT.md updated with architecture diagram
- No code changes this session (design only)

---

## Later: File Naming Simplification (Desktop Session)

Claude Code was down, so Claude Desktop made direct edits.

**Decision:** Changed from type-first-with-ID naming to simple type names (Option A).

Before:
```
sessions/00000000-000000/
  00000000-000000.m4a
  transcript-00000000-000000.json
  ...
```

After:
```
sessions/00000000-000000/
  audio.m4a
  transcript.json
  diarization.json
  audio-info.json
  validation-notes.json
  manifest.json
```

**Rationale:** Folder provides session context. ID in filename is redundant. This is the standard pattern in data pipelines (HuggingFace, DVC, etc.).

**Files edited:**
- `src/pipeline.py` — simple names in manifest and save_computed
- `tools/transcript_validator/server.py` — rewrote to simple paths only, deleted all legacy fallback
- `scripts/migrate_sessions.py` — simplified for current→simple migration
- `tests/test_pipeline.py`, `test_diarize.py`, `test_inspect_audio.py`, `test_transcribe.py` — updated paths
- `CLAUDE.md` — updated docs
- Renamed actual session files

**Verified:** 66 fast tests passing. Pipeline rerun on test session confirmed ghost segments gone.
